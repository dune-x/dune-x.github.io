<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torneo P√°del DUNE ‚Äî Sheets Sync</title>

  <style>
    :root{
      --primary:#0056b3; --bg:#f4f7f6; --card:#fff; --muted:#667;
      --line:#e7e7e7; --win:#d4edda; --loss:#f8d7da;
      --danger:#b00020;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:var(--bg); color:#111;}
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    .header{background:var(--card); border-radius:14px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06);}
    h1{margin:0 0 6px; font-size:1.2rem; color:var(--primary);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{font-size:.9rem; color:var(--muted)}
    .btn{border:0; background:var(--primary); color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:650;}
    .btn.secondary{background:#111;}
    .btn.ghost{background:#e9eef7; color:#123;}
    .btn.danger{background:var(--danger);}
    .btn:disabled{opacity:.5; cursor:not-allowed;}
    .tabs{display:flex; gap:8px; margin:14px 0; flex-wrap:wrap;}
    .tab{background:#e9e9e9; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:650;}
    .tab.active{background:var(--primary); color:#fff;}
    .panel{display:none;}
    .panel.active{display:block;}
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:12px;}
    .card{background:var(--card); border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.06); border-top:5px solid var(--primary);}
    .title{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .title h2{margin:0; font-size:1rem;}
    .small{font-size:.85rem; color:var(--muted);}
    table{width:100%; border-collapse:collapse; font-size:.92rem; margin-top:10px;}
    th{font-size:.78rem; text-transform:uppercase; color:var(--muted); text-align:left; padding:8px 6px; border-bottom:1px solid var(--line);}
    td{padding:8px 6px; border-bottom:1px solid var(--line); vertical-align:middle;}
    .scoreBox{display:flex; gap:6px; align-items:center; justify-content:flex-end;}
    .score{width:54px; padding:8px 10px; border:1px solid #ccd; border-radius:10px; text-align:center; font-weight:800;}
    .score.win{background:var(--win);}
    .score.loss{background:var(--loss);}
    .leader{overflow:auto;}
    .leader table{min-width:820px;}
    .tag{background:#e9eef7; color:#123; font-weight:700; padding:2px 10px; border-radius:999px; font-size:.8rem;}
    .top1{background:#ffd700;}
    .top2{background:#c0c0c0;}
    @media (max-width:520px){
      .score{width:48px;}
      .btn{width:100%;}
    }
    .note{margin-top:10px; font-size:.9rem; color:var(--muted);}
    .statusbar{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      background:#f6f7fb; color:#223; font-size:.92rem;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .statusbar b{color:#111;}
    .warn{color:var(--danger); font-weight:700;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="headerTop">
  <img src="logo.png" alt="Logo DUNE" class="headerLogo">
  <div>
    <h1>Torneo P√°del DUNE-X</h1>
    <div class="small">Resultados en tiempo real</div>
  </div>
</div>
    <div class="row">
      <button class="btn ghost" id="btnReload">üîÑ Recargar del servidor</button>
      <button class="btn secondary" id="btnSave">üíæ Guardar en servidor</button>

      <button class="btn" id="btnAdmin">üîí Entrar como admin</button>
      <button class="btn danger" id="btnLogout" style="display:none;">üö™ Salir admin</button>

      <span class="pill" id="adminState">Modo: SOLO LECTURA</span>
      <span class="pill" id="dirtyState"></span>
    </div>

    <div class="statusbar">
      <div>Servidor: <b id="serverState">‚Äî</b></div>
      <div>√öltima carga: <b id="lastLoad">‚Äî</b></div>
      <div class="small">Auto-refresh: <b id="autoRefreshState">ON</b> (solo en modo lectura)</div>
    </div>

    <p class="note">
      Nota: el guardado ‚Äúpara todo el mundo‚Äù ocurre al pulsar <b>Guardar en servidor</b>.
      Si est√°s en modo lectura, la web se refresca cada 15s para mostrar lo √∫ltimo.
    </p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="schedule">Grupos</button>
    <button class="tab" data-tab="leaderboard">Clasificaci√≥n</button>
    <button class="tab" data-tab="finals">Eliminatorias</button>
  </div>

  <div id="schedule" class="panel active">
    <div id="scheduleGrid" class="grid"></div>
    <p class="note">Tip: escribe ‚Äú6‚Äù ‚Äú3‚Äù y pasa al siguiente. Ganador/perdedor se colorea.</p>
  </div>

  <div id="leaderboard" class="panel">
    <div class="card leader">
      <div class="title">
        <h2>üìä Clasificaci√≥n (3 puntos por victoria)</h2>
        <span class="small">Orden: Puntos ‚Üí Diferencia de juegos ‚Üí Juegos ganados</span>
      </div>
      <table>
        <thead>
          <tr>
            <th># Grupo</th><th>Pareja</th><th>Grupo</th>
            <th>PG</th><th>PP</th><th>JG</th><th>JP</th><th>Dif</th><th>Puntos</th><th>Estado</th>
          </tr>
        </thead>
        <tbody id="leaderTbody"></tbody>
      </table>
    </div>
  </div>

  <div id="finals" class="panel">
    <div class="card">
      <div class="title">
        <h2>üèÜ Eliminatorias</h2>
        <span class="small">Seeding est√°ndar: 1-8, 4-5, 2-7, 3-6</span>
      </div>

      <div class="row" style="margin:10px 0;">
        <button class="btn ghost" id="btnRebuildBrackets">üîÑ Regenerar cuadro seg√∫n clasificaci√≥n</button>
        <span class="small">Si cambias resultados de grupos, pulsa regenerar.</span>
      </div>

      <h3 style="margin:14px 0 8px;">CUADRO ORO (8)</h3>
      <div id="bracketOro"></div>

      <h3 style="margin:18px 0 8px;">CUADRO PLATA (8)</h3>
      <div id="bracketPlata"></div>

      <p class="note">En cada partido: mete resultado (opcional) y selecciona ganador. Eso rellena la siguiente ronda.</p>
    </div>
  </div>
</div>

<script>
/** CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbzrDoBAMbqJf7P6dhA5dNXl3SVzBwmkoqRSi13FDeHr_FkGggDDU2WDxCdf6M3GaIarog/exec";
const ADMIN_PASSWORD = "XDUNEX";
const AUTO_REFRESH_MS = 15000;

/** STATE */
let teams = [];
let matches = [];
let results = {};
let isAdmin = false;
let dirty = false;
let lastServerLoadAt = null;

const byId = (id) => document.getElementById(id);

/** DIRTY + LOCK */
function setDirty(v){
  dirty = !!v;
  byId("dirtyState").textContent = dirty ? "‚ö†Ô∏è Cambios sin guardar" : "";
  byId("dirtyState").className = dirty ? "pill warn" : "pill";
}
function applyEditLock(){
  document.querySelectorAll('#schedule input.score').forEach(el => { el.disabled = !isAdmin; });
  document.querySelectorAll('#finals input.score, #finals select[data-pick]').forEach(el => { el.disabled = !isAdmin; });

  byId("adminState").textContent = isAdmin ? "Modo: ADMIN (EDITANDO)" : "Modo: SOLO LECTURA";
  byId("btnLogout").style.display = isAdmin ? "inline-block" : "none";
  byId("autoRefreshState").textContent = isAdmin ? "OFF" : "ON";
}

/** API */
async function apiLoad(){
  byId("serverState").textContent = "Cargando‚Ä¶";
  try{
    const res = await fetch(API_URL, { cache: "no-store" });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Error API");

    teams = (data.participants || []).map(r => ({
      id: parseInt(r.id),
      group: String(r.group || "").trim().toUpperCase(),
      name: `${r.player1} & ${r.player2}`.trim()
    })).filter(t => t.id && t.group && t.name);

    matches = buildMatches(teams);

    results = {};
    const rmap = data.results || {};
    Object.keys(rmap).forEach(mid => {
      results[mid] = { scoreA: Number(rmap[mid].scoreA) || 0, scoreB: Number(rmap[mid].scoreB) || 0 };
    });

    lastServerLoadAt = new Date();
    byId("lastLoad").textContent = lastServerLoadAt.toLocaleString();
    byId("serverState").textContent = "OK";
    setDirty(false);

    renderAll();
    return true;
  } catch(err){
    byId("serverState").textContent = "ERROR";
    console.error(err);
    alert("Error cargando del servidor: " + err.message);
    return false;
  }
}

async function apiSaveAll(){
  if(!isAdmin){
    alert("Est√°s en SOLO LECTURA. Pulsa ‚ÄúEntrar como admin‚Äù primero.");
    return;
  }
  const pass = prompt("Contrase√±a admin (para guardar en servidor):");
  if(pass !== ADMIN_PASSWORD){
    alert("‚ùå Contrase√±a incorrecta");
    return;
  }

  byId("serverState").textContent = "Guardando‚Ä¶";
  try{
    const payload = { password: pass, results };
    // IMPORTANT√çSIMO: NO mandar Content-Type application/json (evita preflight CORS)
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });

    const txt = await res.text();
    let data;
    try { data = JSON.parse(txt); } catch { throw new Error("Respuesta no JSON: " + txt.slice(0,200)); }
    if(!data.ok) throw new Error(data.error || "Error guardando");

    byId("serverState").textContent = "OK";
    setDirty(false);
    alert("‚úÖ Guardado en servidor (" + data.updated + " partidos)");
    return true;
  } catch(err){
    byId("serverState").textContent = "ERROR";
    console.error(err);
    alert("‚ùå Error guardando: " + err.message);
    return false;
  }
}

/** MATCHES */
function buildMatches(teams){
  const groups = {};
  teams.forEach(t => (groups[t.group] ??= []).push(t));
  const out = [];
  Object.keys(groups).sort().forEach(g => {
    const list = groups[g];
    for(let i=0;i<list.length;i++){
      for(let j=i+1;j<list.length;j++){
        out.push({ id: `${g}-${list[i].id}-${list[j].id}`, group:g, a:list[i].id, b:list[j].id });
      }
    }
  });
  return out;
}

/** RENDER GROUPS */
function renderSchedule(){
  const grid = byId("scheduleGrid");
  grid.innerHTML = "";

  if(!teams.length){
    grid.innerHTML = `
      <div class="card">
        <div class="title"><h2>Sin participantes</h2></div>
        <p class="note">Revisa que en Google Sheets exista la pesta√±a <b>Participants</b> con datos.</p>
      </div>`;
    return;
  }

  const teamById = Object.fromEntries(teams.map(t => [t.id, t]));
  const groupKeys = [...new Set(teams.map(t => t.group))].sort();

  groupKeys.forEach(g => {
    const card = document.createElement("div");
    card.className = "card";

    const groupTeams = teams.filter(t => t.group === g);
    const groupMatches = matches.filter(m => m.group === g);

    card.innerHTML = `
      <div class="title">
        <h2>GRUPO ${g}</h2>
        <span class="tag">${groupTeams.length} parejas</span>
      </div>
      <div class="small">${groupTeams.map(t => t.name).join(" ¬∑ ")}</div>
      <table>
        <thead><tr><th>Partido</th><th style="text-align:right;">Resultado</th></tr></thead>
        <tbody>
          ${groupMatches.map(m => {
            const aName = teamById[m.a]?.name ?? m.a;
            const bName = teamById[m.b]?.name ?? m.b;
            const r = results[m.id] || {scoreA:0, scoreB:0};
            const clsA = (r.scoreA>r.scoreB) ? "win" : (r.scoreA<r.scoreB ? "loss" : "");
            const clsB = (r.scoreB>r.scoreA) ? "win" : (r.scoreB<r.scoreA ? "loss" : "");
            return `
              <tr data-mid="${m.id}">
                <td>${aName} <span class="small">vs</span> ${bName}</td>
                <td>
                  <div class="scoreBox">
                    <input class="score ${clsA}" type="number" min="0" max="9" value="${r.scoreA}" data-side="A"/>
                    <span class="small">-</span>
                    <input class="score ${clsB}" type="number" min="0" max="9" value="${r.scoreB}" data-side="B"/>
                  </div>
                </td>
              </tr>`;
          }).join("")}
        </tbody>
      </table>
    `;
    grid.appendChild(card);
  });

  grid.querySelectorAll("tr[data-mid] input.score").forEach(inp => {
    inp.addEventListener("input", (e) => {
      const tr = e.target.closest("tr");
      const mid = tr.getAttribute("data-mid");
      const a = tr.querySelector('input[data-side="A"]');
      const b = tr.querySelector('input[data-side="B"]');
      results[mid] = { scoreA: parseInt(a.value)||0, scoreB: parseInt(b.value)||0 };
      setDirty(true);
      renderAll();
    });
  });
}

/** LEADERBOARD */
function computeLeaderboard(){
  const stats = {};
  teams.forEach(t => stats[t.id] = { id:t.id, name:t.name, group:t.group, pg:0, pp:0, jg:0, jp:0, diff:0, points:0 });

  matches.forEach(m => {
    const r = results[m.id]; if(!r) return;
    const a = stats[m.a], b = stats[m.b]; if(!a || !b) return;

    const sa = r.scoreA||0, sb = r.scoreB||0;
    if(sa===0 && sb===0) return;

    a.jg+=sa; a.jp+=sb; b.jg+=sb; b.jp+=sa;
    if(sa>sb){ a.pg++; a.points+=3; b.pp++; }
    else if(sb>sa){ b.pg++; b.points+=3; a.pp++; }
  });

  Object.values(stats).forEach(s => s.diff = s.jg - s.jp);

  const grouped = {};
  Object.values(stats).forEach(s => (grouped[s.group] ??= []).push(s));

  const ordered = [];
  Object.keys(grouped).sort().forEach(g => {
    grouped[g].sort((x,y)=>(y.points-x.points)||(y.diff-x.diff)||(y.jg-x.jg));
    ordered.push(...grouped[g]);
  });
  return ordered;
}

function renderLeaderboard(){
  const tbody = byId("leaderTbody");
  tbody.innerHTML = "";
  if(!teams.length) return;

  const ordered = computeLeaderboard();
  let lastGroup = null;

  ordered.forEach((t, idx) => {
    let groupRank = 1;
    for(let i=idx-1; i>=0 && ordered[i].group===t.group; i--) groupRank++;

    if(lastGroup !== null && t.group !== lastGroup){
      const sep = document.createElement("tr");
      sep.innerHTML = `<td colspan="10" style="background:#eee; height:8px; padding:0; border:0;"></td>`;
      tbody.appendChild(sep);
    }

    let status="‚Äî", cls="";
    if(groupRank===1){ status="1¬∫ Grupo (ORO)"; cls="top1"; }
    else if(groupRank===2){ status="2¬∫ Grupo"; cls="top2"; }
    else if(groupRank===3){ status="3¬∫ Grupo"; }
    else status="4¬∫ Grupo";

    const tr = document.createElement("tr");
    if(cls) tr.className = cls;
    tr.innerHTML = `
      <td><b>${groupRank}</b></td>
      <td><b>${t.name}</b></td>
      <td>${t.group}</td>
      <td>${t.pg}</td>
      <td>${t.pp}</td>
      <td>${t.jg}</td>
      <td>${t.jp}</td>
      <td>${t.diff}</td>
      <td><b>${t.points}</b></td>
      <td>${status}</td>
    `;
    tbody.appendChild(tr);
    lastGroup = t.group;
  });
}

/** BRACKETS */
const BRACKET_LOCAL_KEY = "dune_brackets_local_v1";

function loadBrackets(){
  const raw = localStorage.getItem(BRACKET_LOCAL_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
let brackets = loadBrackets() || { oro: {}, plata: {} };

function saveBrackets(){
  localStorage.setItem(BRACKET_LOCAL_KEY, JSON.stringify(brackets));
}

function computeGroupRankMap(ordered){
  const map = { first: [], second: [], third: [], fourth: [] };
  const groups = [...new Set(ordered.map(x=>x.group))].sort();

  groups.forEach(g => {
    const arr = ordered.filter(x => x.group===g);
    if(arr[0]) map.first.push(arr[0]);
    if(arr[1]) map.second.push(arr[1]);
    if(arr[2]) map.third.push(arr[2]);
    if(arr[3]) map.fourth.push(arr[3]);
  });

  const sortGlobal = (a,b)=>(b.points-a.points)||(b.diff-a.diff)||(b.jg-a.jg);
  map.second.sort(sortGlobal);
  map.third.sort(sortGlobal);
  return map;
}

function buildSeedsFromLeaderboard(){
  const ordered = computeLeaderboard();
  const rankMap = computeGroupRankMap(ordered);

  const oro = [];
  rankMap.first.forEach(x => oro.push(x));
  if(rankMap.second[0]) oro.push(rankMap.second[0]);

  const plata = [];
  rankMap.second.slice(1).forEach(x => plata.push(x));
  rankMap.third.slice(0,2).forEach(x => plata.push(x));

  return { oro: oro.slice(0,8), plata: plata.slice(0,8) };
}

function defaultBracketFromSeeds(seeds){
  const s = seeds.map(x => x ? x.id : null);
  return {
    qf: [
      { a:s[0], b:s[7], winner:null, scoreA:0, scoreB:0 },
      { a:s[3], b:s[4], winner:null, scoreA:0, scoreB:0 },
      { a:s[1], b:s[6], winner:null, scoreA:0, scoreB:0 },
      { a:s[2], b:s[5], winner:null, scoreA:0, scoreB:0 }
    ],
    sf: [
      { a:null, b:null, winner:null, scoreA:0, scoreB:0 },
      { a:null, b:null, winner:null, scoreA:0, scoreB:0 }
    ],
    f: { a:null, b:null, winner:null, scoreA:0, scoreB:0 }
  };
}

function propagateWinners(which){
  const br = brackets[which];
  br.sf[0].a = br.qf[0].winner ?? null;
  br.sf[0].b = br.qf[1].winner ?? null;
  br.sf[1].a = br.qf[2].winner ?? null;
  br.sf[1].b = br.qf[3].winner ?? null;

  br.f.a = br.sf[0].winner ?? null;
  br.f.b = br.sf[1].winner ?? null;
}

function rebuildBracketsFromGroups(){
  if(!teams.length) return;
  const seeds = buildSeedsFromLeaderboard();
  brackets.oro = defaultBracketFromSeeds(seeds.oro);
  brackets.plata = defaultBracketFromSeeds(seeds.plata);
  propagateWinners("oro");
  propagateWinners("plata");
  saveBrackets();
  renderBrackets();
}

function ensureBrackets(){
  if(!brackets.oro?.qf || !brackets.plata?.qf){
    rebuildBracketsFromGroups();
  } else {
    propagateWinners("oro");
    propagateWinners("plata");
    saveBrackets();
  }
}

function renderSingleBracket(which, mountId){
  const mount = byId(mountId);
  const br = brackets[which];
  if(!br || !br.qf){
    mount.innerHTML = `<p class="note">No hay cuadro todav√≠a. Pulsa ‚ÄúRegenerar cuadro‚Äù.</p>`;
    return;
  }

  const teamById = Object.fromEntries(teams.map(t => [t.id, t.name]));
  const name = (id) => id ? (teamById[id] || `Equipo ${id}`) : "‚Äî";

  function row(stage, idx, m){
    const opts = [`<option value="">Ganador‚Ä¶</option>`];
    if(m.a) opts.push(`<option value="${m.a}" ${m.winner===m.a?"selected":""}>${name(m.a)}</option>`);
    if(m.b) opts.push(`<option value="${m.b}" ${m.winner===m.b?"selected":""}>${name(m.b)}</option>`);
    return `
      <tr data-match="${which}-${stage}-${idx}">
        <td>${name(m.a)} <span class="small">vs</span> ${name(m.b)}</td>
        <td style="text-align:right;">
          <input class="score" type="number" min="0" max="9" value="${m.scoreA||0}" data-side="A">
          <span class="small">-</span>
          <input class="score" type="number" min="0" max="9" value="${m.scoreB||0}" data-side="B">
        </td>
        <td style="text-align:right;">
          <select data-pick style="padding:8px; border-radius:10px; border:1px solid #ccd;">
            ${opts.join("")}
          </select>
        </td>
      </tr>`;
  }

  mount.innerHTML = `
    <div style="overflow:auto;">
      <table>
        <thead><tr><th>Partido</th><th style="text-align:right;">Resultado</th><th style="text-align:right;">Ganador</th></tr></thead>
        <tbody>
          <tr><td colspan="3" style="background:#f6f7fb; font-weight:800;">Cuartos</td></tr>
          ${br.qf.map((m,i)=>row("qf",i,m)).join("")}
          <tr><td colspan="3" style="background:#f6f7fb; font-weight:800;">Semis</td></tr>
          ${br.sf.map((m,i)=>row("sf",i,m)).join("")}
          <tr><td colspan="3" style="background:#f6f7fb; font-weight:800;">Final</td></tr>
          ${row("f",0,br.f)}
        </tbody>
      </table>
    </div>`;

  mount.querySelectorAll("tr[data-match]").forEach(tr => {
    const [_, stage, idxStr] = tr.getAttribute("data-match").split("-");
    const idx = parseInt(idxStr,10);
    const scoreA = tr.querySelector('input[data-side="A"]');
    const scoreB = tr.querySelector('input[data-side="B"]');
    const pick = tr.querySelector('select[data-pick]');

    function ref(){
      const b = brackets[which];
      if(stage==="qf") return b.qf[idx];
      if(stage==="sf") return b.sf[idx];
      return b.f;
    }

    scoreA.addEventListener("input", () => { const m=ref(); m.scoreA=parseInt(scoreA.value)||0; setDirty(true); saveBrackets(); });
    scoreB.addEventListener("input", () => { const m=ref(); m.scoreB=parseInt(scoreB.value)||0; setDirty(true); saveBrackets(); });
    pick.addEventListener("change", () => {
      const m=ref();
      m.winner = pick.value ? parseInt(pick.value,10) : null;
      setDirty(true);
      propagateWinners(which);
      saveBrackets();
      renderBrackets();
    });
  });
}

function renderBrackets(){
  ensureBrackets();
  renderSingleBracket("oro","bracketOro");
  renderSingleBracket("plata","bracketPlata");
  applyEditLock();
}

/** RENDER ALL */
function renderAll(){
  renderSchedule();
  renderLeaderboard();
  renderBrackets();
  applyEditLock();
}

/** TABS */
document.querySelectorAll(".tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    byId(btn.dataset.tab).classList.add("active");
    renderLeaderboard();
    renderBrackets();
    applyEditLock();
  });
});

/** ADMIN */
byId("btnAdmin").addEventListener("click", () => {
  const pass = prompt("Contrase√±a admin:");
  if(pass === ADMIN_PASSWORD){
    isAdmin = true;
    applyEditLock();
    alert("‚úÖ Modo admin activado");
  }else alert("‚ùå Contrase√±a incorrecta");
});
byId("btnLogout").addEventListener("click", () => {
  if(dirty && !confirm("Tienes cambios sin guardar. ¬øSalir igualmente?")) return;
  isAdmin = false;
  applyEditLock();
});

/** BUTTONS */
byId("btnReload").addEventListener("click", async () => {
  if(isAdmin && dirty && !confirm("Tienes cambios sin guardar. Recargar los perder√°. ¬øContinuar?")) return;
  await apiLoad();
});
byId("btnSave").addEventListener("click", apiSaveAll);
byId("btnRebuildBrackets").addEventListener("click", rebuildBracketsFromGroups);

/** AUTO REFRESH */
setInterval(() => {
  if(isAdmin) return;
  if(dirty) return;
  apiLoad().catch(()=>{});
}, AUTO_REFRESH_MS);

/** BOOT */
(async function boot(){
  applyEditLock();
  await apiLoad();
})();
</script>
</body>
</html>

